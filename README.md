README for psa-crypto
=====================

The PSA Cryptography repository contains a reference implementation of the [PSA Cryptography API and its unified driver interface](https://armmbed.github.io/mbed-crypto/psa/#application-programming-interface). This encompasses the on-going extensions to the PSA Cryptography API like currently PAKE.

Compiling
---------

The build system is CMake.
The CMake build system creates one library: libpsacrypto.

### Tool versions

You need the following tools to build the library from the main branch with the provided CMake files:

* A C99 toolchain (compiler, linker, archiver). We actively test with GCC 5.4, Clang 3.8. More recent versions should work. Slightly older versions may work.
* Python 3.6 to generate the test code, and to generate sample programs in the main branch.
* Perl to run the tests, and to generate some source files in the main branch.
* CMake 3.10.2 or later.

### Generated source files in the main branch

The source code of PSA cryptography includes some files that are automatically generated by scripts and whose content depends only on the PSA cryptography source, not on the platform or on the library configuration. These files are not included in the main branch. This section explains how to generate the missing files in the main branch.

The following tools are required:

* Python 3 and some Python packages, for some library source files, sample programs and test data. To install the necessary packages, run
    ```
    python -m pip install -r scripts/basic.requirements.txt
    ```
* A C compiler for the host platform, for some test data.

If you are cross-compiling, you must set the `CC` environment variable to a C compiler for the host platform when generating the configuration-independent files.

Any of the following methods are available to generate the configuration-independent files:

* When not cross-compiling, CMake will generate the required files automatically.
* Run `tests/scripts/check-generated-files.sh -u` to generate all the configuration-independent files.

### CMake

In order to build the source using CMake in a separate directory (recommended), just enter at the command line:

    mkdir /path/to/build_dir && cd /path/to/build_dir
    cmake /path/to/psa/crypto/source
    cmake --build .

In order to run the tests, enter:

    ctest

The test suites need Python to be built and Perl to be executed. If you don't have one of these installed, you'll want to disable the test suites with:

    cmake -DENABLE_TESTING=Off /path/to/psa/crypto/source

To configure CMake for building shared libraries, use:

    cmake -DUSE_SHARED_PSA_CRYPTO_LIBRARY=On /path/to/psa/crypto/source

There are many different build modes available within the CMake buildsystem. Most of them are available for gcc and clang, though some are compiler-specific:

-   `Release`. This generates the default code without any unnecessary information in the binary files.
-   `Debug`. This generates debug information and disables optimization of the code.
-   `ASan`. This instruments the code with AddressSanitizer to check for memory errors. (This includes LeakSanitizer, with recent version of gcc and clang.) (With recent version of clang, this mode also instruments the code with UndefinedSanitizer to check for undefined behaviour.)
-   `ASanDbg`. Same as ASan but slower, with debug information and better stack traces.
-   `MemSan`. This instruments the code with MemorySanitizer to check for uninitialised memory reads. Experimental, needs recent clang on Linux/x86\_64.
-   `MemSanDbg`. Same as MemSan but slower, with debug information, better stack traces and origin tracking.
-   `Check`. This activates the compiler warnings that depend on optimization and treats all warnings as errors.

Switching build modes in CMake is simple. For debug mode, enter at the command line:

    cmake -D CMAKE_BUILD_TYPE=Debug /path/to/psa/crypto/source

To list other available CMake options, use:

    cmake -LH

Note that, with CMake, you can't adjust the compiler or its flags after the
initial invocation of cmake. This means that `CC=your_cc make` and `make
CC=your_cc` will *not* work (similarly with `CFLAGS` and other variables).
These variables need to be adjusted when invoking cmake for the first time,
for example:

    CC=your_cc cmake /path/to/psa/crypto/source

If you already invoked cmake and want to change those settings, you need to
remove the build directory and create it again.

Note that it is possible to build in-place; this will however overwrite the
provided Makefiles (see `scripts/tmp_ignore_makefiles.sh` if you want to
prevent `git status` from showing them as modified). In order to do so, from
the PSA cryptography source directory, use:

    cmake .
    make

If you want to change `CC` or `CFLAGS` afterwards, you will need to remove the
CMake cache. This can be done with the following command using GNU find:

    find . -iname '*cmake*' -not -name CMakeLists.txt -exec rm -rf {} +

You can now make the desired change:

    CC=your_cc cmake .
    make

Regarding variables, also note that if you set CFLAGS when invoking cmake,
your value of CFLAGS doesn't override the content provided by cmake (depending
on the build mode as seen above), it's merely prepended to it.

Example programs
----------------

We've included example programs for different features and uses in [`programs/`](programs/README.md).
Please note that the goal of these sample programs is to demonstrate specific features of the library, and the code may need to be adapted to build a real-world application.

Tests
-----

PSA cryptography includes an elaborate test suite in `tests/` that initially requires Python to generate the tests files (e.g. `test\_suite\_psa\_crypto.c`). These files are generated from a `function file` (e.g. `suites/test\_suite\_psa\_crypto.function`) and a `data file` (e.g. `suites/test\_suite\_psa\_crypto.data`). The `function file` contains the test functions. The `data file` contains the test cases, specified as parameters that will be passed to the test function.

License
-------

Unless specifically indicated otherwise in a file, PSA cryptography files are provided under the [Apache-2.0](https://spdx.org/licenses/Apache-2.0.html) license. See the [LICENSE](LICENSE) file for the full text of this license. Contributors must accept that their contributions are made under both the Apache-2.0 AND [GPL-2.0-or-later](https://spdx.org/licenses/GPL-2.0-or-later.html) licenses.
